<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FPL Controllable Load Model</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Base styles for body and container */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light gray background */
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 2rem;
            box-sizing: border-box;
        }
        .model-container {
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            padding: 2.5rem;
            width: 100%;
            max-width: 1200px; /* Wider for more content */
            box-sizing: border-box;
        }

        /* Typography */
        h1 {
            font-size: 2.25rem; /* text-4xl */
            font-weight: 700; /* font-bold */
            color: #1e293b; /* slate-900 */
            margin-bottom: 0.5rem;
            text-align: center;
        }
        h2 {
            font-size: 1.5rem; /* text-2xl */
            font-weight: 600; /* font-semibold */
            color: #334155; /* slate-700 */
            margin-top: 2rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #e2e8f0; /* slate-200 */
            padding-bottom: 0.5rem;
        }
        h3 {
            font-size: 1.25rem; /* text-xl */
            font-weight: 600; /* font-semibold */
            color: #475569; /* slate-600 */
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
        }

        /* Input Group Styling */
        .input-group {
            display: flex;
            flex-direction: column;
            margin-bottom: 1rem;
        }
        .input-group label {
            font-weight: 500;
            color: #475569;
            margin-bottom: 0.25rem;
            font-size: 0.9rem;
        }
        .input-group input[type="number"],
        .input-group input[type="text"] {
            padding: 0.6rem 0.8rem;
            border: 1px solid #cbd5e1; /* slate-300 */
            border-radius: 0.5rem;
            font-size: 1rem;
            color: #1e293b;
            background-color: #f8fafc; /* slate-50 */
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .input-group input:focus {
            outline: none;
            border-color: #6366f1; /* indigo-500 */
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2); /* indigo-500 with opacity */
        }
        .input-explanation {
            color: #64748b; /* slate-500 */
            font-size: 0.75rem; /* text-xs */
            margin-top: 0.25rem;
        }
        .grid-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); /* Adjusted minmax for better spacing */
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        /* Fixed Assumptions Styling */
        .fixed-assumptions-list {
            list-style: disc;
            margin-left: 1.5rem;
            color: #475569;
            font-size: 0.9rem;
        }
        .fixed-assumptions-list li {
            margin-bottom: 0.5rem;
        }

        /* Table Styling */
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 1.5rem;
            background-color: #f8fafc; /* slate-50 */
            border-radius: 0.75rem;
            overflow: hidden; /* Ensures rounded corners apply to content */
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        th, td {
            padding: 0.8rem 1rem;
            border-bottom: 1px solid #e2e8f0; /* slate-200 */
            text-align: right;
            font-size: 0.9rem;
            color: #334155; /* slate-700 */
        }
        th {
            background-color: #e2e8f0; /* slate-200 */
            font-weight: 600;
            color: #1e293b; /* slate-900 */
            text-align: center;
        }
        th:first-child, td:first-child {
            text-align: left;
        }
        tr:last-child td {
            border-bottom: none;
        }
        tbody tr:hover {
            background-color: #eff6ff; /* blue-50 */
        }
        .summary-table th, .summary-table td {
            font-size: 1rem;
            font-weight: 500;
        }
        .summary-table th:first-child {
             text-align: left;
        }
        .summary-table td:last-child {
            font-weight: 700;
            color: #10b981; /* emerald-500 */
        }

        /* Chart Styling (Simple ASCII/Bar Chart) */
        .chart-container {
            margin-top: 2rem;
            padding: 1.5rem;
            background-color: #e0f2f7; /* light blue */
            border-radius: 0.75rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            overflow-x: auto; /* Allow scrolling for wider charts */
        }
        .chart-row {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
            font-family: monospace;
            font-size: 0.85rem;
            color: #083344; /* cyan-900 */
        }
        .chart-year {
            width: 40px;
            text-align: right;
            padding-right: 5px;
        }
        .chart-bar-container {
            flex-grow: 1;
            height: 16px;
            background-color: #a7f3d0; /* emerald-200 */
            border-radius: 4px;
            position: relative;
            margin-right: 10px;
        }
        .chart-bar {
            height: 100%;
            background-color: #0d9488; /* teal-600 */
            border-radius: 4px;
            transition: width 0.5s ease-out;
        }
        .chart-value {
            min-width: 60px;
            text-align: left;
            font-weight: bold;
        }
        .chart-label {
            font-weight: bold;
            margin-bottom: 1rem;
            color: #083344;
            text-align: center;
        }

        /* Tooltip styles */
        .tooltip-container {
            position: relative;
            display: inline-block;
            cursor: help;
        }
        .tooltip-text {
            visibility: hidden;
            width: 200px;
            background-color: #334155; /* slate-700 */
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%; /* Position above the text */
            left: 50%;
            margin-left: -100px; /* Center the tooltip */
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.7rem;
            line-height: 1.2;
            pointer-events: none; /* Allows clicks through tooltip */
        }
        .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #334155 transparent transparent transparent;
        }
        .tooltip-container:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        .info-icon {
            font-size: 0.7em; /* Smaller info icon */
            vertical-align: super; /* Aligns it nicely with text */
            margin-left: 0.2em;
            color: #64748b; /* slate-500 */
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .model-container {
                padding: 1.5rem;
            }
            h1 {
                font-size: 1.75rem; /* text-3xl */
            }
            h2 {
                font-size: 1.25rem; /* text-xl */
            }
            h3 {
                font-size: 1rem; /* text-lg */
            }
            .grid-inputs {
                grid-template-columns: 1fr; /* Stack inputs vertically */
            }
            table, th, td {
                font-size: 0.8rem;
                padding: 0.6rem 0.8rem;
            }
            .chart-year {
                width: 30px;
            }
            .chart-value {
                min-width: 50px;
            }
            .tooltip-text {
                width: 150px; /* Smaller tooltip on mobile */
                margin-left: -75px;
            }
        }
    </style>
</head>
<body>
    <div class="model-container">
        <h1>FPL Controllable Load Financial Model</h1>
        <p class="text-gray-600 text-center mb-8">Quantifying Load Reduction from HVAC & Water Heater On-Bill Programs</p>

        <!-- Tab 1: Assumptions & Inputs -->
        <h2>1. Assumptions & Inputs</h2>
        <p class="text-gray-500 mb-6 text-sm">Adjust these values to see their impact on the projected controllable load.</p>

        <div class="grid-inputs">
            <div class="input-group">
                <label for="projectionYears">A. Program Horizon (Years)</label>
                <input type="number" id="projectionYears" value="15" min="1" max="30">
                <p class="input-explanation">Number of years for the model's projection.</p>
            </div>
            <div class="input-group">
                <label for="totalAddressableHomeowners">B. Total Installed Base (FPL Service Territory)</label>
                <input type="number" id="totalAddressableHomeowners" value="3200000" min="100000">
                <p class="input-explanation">Total existing homes with relevant devices (HVAC/WH) in the FPL service area.</p>
            </div>
            <div class="input-group">
                <label for="eligibleMarketPenetration">Eligible Installed Base Penetration (%)</label>
                <input type="number" id="eligibleMarketPenetration" value="85" step="1" min="0" max="100">
                <p class="input-explanation">Percentage of the total installed base that qualifies for the program (e.g., central AC, electric water heater, owner-occupied).</p>
            </div>
            <div class="input-group">
                <label for="hvacLifespan">HVAC Device Lifespan (Years)</label>
                <input type="number" id="hvacLifespan" value="12" min="5">
                <p class="input-explanation">Average expected useful life of an HVAC unit.</p>
            </div>
            <div class="input-group">
                <label for="whLifespan">Water Heater Device Lifespan (Years)</label>
                <input type="number" id="whLifespan" value="8" min="5">
                <p class="input-explanation">Average expected useful life of a Water Heater.</p>
            </div>
            <div class="input-group">
                <label for="hvacAnnualReplacementOpportunity">HVAC Annual Replacement Opportunity (Units)</label>
                <input type="number" id="hvacAnnualReplacementOpportunity" value="266667" min="0">
                <p class="input-explanation">Estimated number of HVAC units retiring annually that are eligible for replacement. This drives program enrollment.</p>
            </div>
            <div class="input-group">
                <label for="whAnnualReplacementOpportunity">Water Heater Annual Replacement Opportunity (Units)</label>
                <input type="number" id="whAnnualReplacementOpportunity" value="400000" min="0">
                <p class="input-explanation">Estimated number of Water Heater units retiring annually that are eligible for replacement. This drives program enrollment.</p>
            </div>
            <div class="input-group">
                <label for="adoptionRateY1_2">Annual Adoption Rate - Year 1-2 (Ramp-up %)</label>
                <input type="number" id="adoptionRateY1_2" value="0.5" step="0.1" min="0">
                <p class="input-explanation">Yearly percentage of the annual replacement opportunity joining during initial ramp-up.</p>
            </div>
            <div class="input-group">
                <label for="adoptionRateY3_5">Annual Adoption Rate - Year 3-5 (Growth %)</label>
                <input type="number" id="adoptionRateY3_5" value="1.5" step="0.1" min="0">
                <p class="input-explanation">Yearly percentage of the annual replacement opportunity joining during the growth phase.</p>
            </div>
            <div class="input-group">
                <label for="adoptionRateY6_10">Annual Adoption Rate - Year 6-10 (Mature %)</label>
                <input type="number" id="adoptionRateY6_10" value="1.0" step="0.1" min="0">
                <p class="input-explanation">Yearly percentage of the annual replacement opportunity joining during the mature phase.</p>
            </div>
            <div class="input-group">
                <label for="adoptionRateY11_15plus">Annual Adoption Rate - Year 11-15+ (Steady State %)</label>
                <input type="number" id="adoptionRateY11_15plus" value="0.5" step="0.1" min="0">
                <p class="input-explanation">Yearly percentage of the annual replacement opportunity joining in the long-term.</p>
            </div>
            <div class="input-group">
                <label for="hvacKwReduction">C. HVAC Average kW Reduction per Device (during event)</label>
                <input type="number" id="hvacKwReduction" value="1.25" step="0.05" min="0.1">
                <p class="input-explanation">Estimated power reduction (kW) from one HVAC unit during a demand response event (1.0 - 1.5 kW range).</p>
            </div>
            <div class="input-group">
                <label for="whKwReduction">Water Heater Average kW Reduction per Device (during event)</label>
                <input type="number" id="whKwReduction" value="0.75" step="0.05" min="0.1">
                <p class="input-explanation">Estimated power reduction (kW) from one water heater during a demand response event (0.5 - 1.0 kW range).</p>
            </div>
            <div class="input-group">
                <label for="hvacCoincidenceFactor">HVAC Coincidence Factor (%)</label>
                <input type="number" id="hvacCoincidenceFactor" value="80" step="1" min="0" max="100">
                <p class="input-explanation">Percentage of enrolled HVAC devices expected to be running during a peak event.</p>
            </div>
            <div class="input-group">
                <label for="whCoincidenceFactor">Water Heater Coincidence Factor (%)</label>
                <input type="number" id="whCoincidenceFactor" value="40" step="1" min="0" max="100">
                <p class="input-explanation">Percentage of enrolled Water Heater devices expected to be actively heating during a peak event.</p>
            </div>
            <div class="input-group">
                <label for="hvacParticipationRate">HVAC Customer Participation/Availability Rate (%)</label>
                <input type="number" id="hvacParticipationRate" value="88" step="1" min="0" max="100">
                <p class="input-explanation">Percentage of enrolled HVAC devices that respond during a control event (accounts for opt-outs).</p>
            </div>
            <div class="input-group">
                <label for="whParticipationRate">Water Heater Customer Participation/Availability Rate (%)</label>
                <input type="number" id="whParticipationRate" value="80" step="1" min="0" max="100">
                <p class="input-explanation">Percentage of enrolled Water Heater devices that respond during a control event (accounts for opt-outs).</p>
            </div>
            <div class="input-group">
                <label for="realWorldDerateFactor">Real-World Derate Factor (%)</label>
                <input type="number" id="realWorldDerateFactor" value="85" step="1" min="0" max="100">
                <p class="input-explanation">Factor for real-world losses (e.g., overrides, inefficiencies).</p>
            </div>
        </div>

        <h3>Fixed Assumptions (Not Editable)</h3>
        <p class="text-gray-500 mb-4 text-sm">These assumptions are built into the model's logic for this high-level overview.</p>
        <ul class="fixed-assumptions-list">
            <li>Program Type: On-Bill Financing for appliance replacement.</li>
            <li>Targeted Appliances: High-efficiency Central HVAC (16 SEER2+) and Hybrid Electric Water Heaters (UEF 3.0+).</li>
            <li>Load Control Technology: Direct Load Control (DLC) switches/devices directly on the appliance.</li>
            <li>Load Control Event Duration: Typical 2-4 hours per event.</li>
            <li>Load Control Event Frequency: Assumed: 5-10 events per month during peak season (e.g., June-September), with a maximum of 20-30 events annually. (Note: This frequency is a key operational decision; starting with lower frequency for a new program may enhance customer satisfaction and sustained participation.)</li>
            <li>Customer Override: Program includes a customer override option for load control events.</li>
            <li>Geographic Scope: FPL residential service territory.</li>
            <li>Average Events per Year: 25.</li>
            <li>Average Hours per Event: 3.</li>
            <li>No Existing FPL DR Programs: Model does not incorporate historical FPL-specific DR data.</li>
            <li>No Smart Meter Disaggregation: Model uses direct kW reduction estimates, not derived from smart meter disaggregation.</li>
        </ul>


        <!-- Tab 2: Device-Specific Load Projections -->
        <h2>2. Device-Specific Load Projections</h2>
        <p class="text-gray-500 mb-4 text-sm">Detailed year-by-year projections for each device type.</p>

        <h3>Central HVAC Projections</h3>
        <div class="overflow-x-auto">
            <table id="hvacProjectionsTable">
                <thead>
                    <tr>
                        <th>Year</th>
                        <th>
                            Eligible Market (Remaining)
                            <span class="tooltip-container">
                                <span class="info-icon">&#9432;</span>
                                <span class="tooltip-text">Total eligible devices not yet enrolled from the initial eligible installed base.</span>
                            </span>
                        </th>
                        <th>
                            Annual Adoption Rate (%)
                            <span class="tooltip-container">
                                <span class="info-icon">&#9432;</span>
                                <span class="tooltip-text">Percentage of the annual replacement opportunity that enrolls each year.</span>
                            </span>
                        </th>
                        <th>
                            Annual Replacement Opportunity (Units)
                            <span class="tooltip-container">
                                <span class="info-icon">&#9432;</span>
                                <span class="tooltip-text">Estimated number of units retiring annually that are eligible for replacement. This is a key driver for new installations.</span>
                            </span>
                        </th>
                        <th>
                            New Installations (Units)
                            <span class="tooltip-container">
                                <span class="info-icon">&#9432;</span>
                                <span class="tooltip-text">Number of new devices installed through the program this year. Calculated from Annual Replacement Opportunity * Adoption Rate.</span>
                            </span>
                        </th>
                        <th>
                            Cumulative Installations (Units)
                            <span class="tooltip-container">
                                <span class="info-icon">&#9432;</span>
                                <span class="tooltip-text">Total devices installed through the program up to this year.</span>
                            </span>
                        </th>
                        <th>
                            Devices Retired This Year (Units)
                            <span class="tooltip-container">
                                <span class="info-icon">&#9432;</span>
                                <span class="tooltip-text">Devices installed through the program that have reached their end-of-life this year.</span>
                            </span>
                        </th>
                        <th>
                            Cumulative Active Devices (Units)
                            <span class="tooltip-container">
                                <span class="info-icon">&#9432;</span>
                                <span class="tooltip-text">Total devices currently active and enrolled in the program (Installations - Retirements).</span>
                            </span>
                        </th>
                        <th>
                            Event Capacity (kW)
                            <span class="tooltip-container">
                                <span class="info-icon">&#9432;</span>
                                <span class="tooltip-text">Instantaneous power reduction (kW) available during a single demand response event. Calculated from Active Devices * kW Reduction * Coincidence Factor * Participation Rate * Derate Factor.</span>
                            </span>
                        </th>
                        <th>
                            Annual Energy Saved (kWh)
                            <span class="tooltip-container">
                                <span class="info-icon">&#9432;</span>
                                <span class="tooltip-text">Total energy saved (kWh) over the year. Calculated from Event Capacity * Events per Year * Hours per Event.</span>
                            </span>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Rows will be populated by JavaScript -->
                </tbody>
            </table>
        </div>

        <h3>Water Heater Projections</h3>
        <div class="overflow-x-auto">
            <table id="whProjectionsTable">
                <thead>
                    <tr>
                        <th>Year</th>
                        <th>
                            Eligible Market (Remaining)
                            <span class="tooltip-container">
                                <span class="info-icon">&#9432;</span>
                                <span class="tooltip-text">Total eligible devices not yet enrolled from the initial eligible installed base.</span>
                            </span>
                        </th>
                        <th>
                            Annual Adoption Rate (%)
                            <span class="tooltip-container">
                                <span class="info-icon">&#9432;</span>
                                <span class="tooltip-text">Percentage of the annual replacement opportunity that enrolls each year.</span>
                            </span>
                        </th>
                        <th>
                            Annual Replacement Opportunity (Units)
                            <span class="tooltip-container">
                                <span class="info-icon">&#9432;</span>
                                <span class="tooltip-text">Estimated number of units retiring annually that are eligible for replacement. This is a key driver for new installations.</span>
                            </span>
                        </th>
                        <th>
                            New Installations (Units)
                            <span class="tooltip-container">
                                <span class="info-icon">&#9432;</span>
                                <span class="tooltip-text">Number of new devices installed through the program this year. Calculated from Annual Replacement Opportunity * Adoption Rate.</span>
                            </span>
                        </th>
                        <th>
                            Cumulative Installations (Units)
                            <span class="tooltip-container">
                                <span class="info-icon">&#9432;</span>
                                <span class="tooltip-text">Total devices installed through the program up to this year.</span>
                            </span>
                        </th>
                        <th>
                            Devices Retired This Year (Units)
                            <span class="tooltip-container">
                                <span class="info-icon">&#9432;</span>
                                <span class="tooltip-text">Devices installed through the program that have reached their end-of-life this year.</span>
                            </span>
                        </th>
                        <th>
                            Cumulative Active Devices (Units)
                            <span class="tooltip-container">
                                <span class="info-icon">&#9432;</span>
                                <span class="tooltip-text">Total devices currently active and enrolled in the program (Installations - Retirements).</span>
                            </span>
                        </th>
                        <th>
                            Event Capacity (kW)
                            <span class="tooltip-container">
                                <span class="info-icon">&#9432;</span>
                                <span class="tooltip-text">Instantaneous power reduction (kW) available during a single demand response event. Calculated from Active Devices * kW Reduction * Coincidence Factor * Participation Rate * Derate Factor.</span>
                            </span>
                        </th>
                        <th>
                            Annual Energy Saved (kWh)
                            <span class="tooltip-container">
                                <span class="info-icon">&#9432;</span>
                                <span class="tooltip-text">Total energy saved (kWh) over the year. Calculated from Event Capacity * Events per Year * Hours per Event.</span>
                            </span>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Rows will be populated by JavaScript -->
                </tbody>
            </table>
        </div>

        <!-- Tab 3: Total Controllable Load Summary -->
        <h2>3. Total Controllable Load Summary</h2>
        <p class="text-gray-500 mb-4 text-sm">This shows the total controllable load capacity and energy savings FPL can manage over time.</p>
        <div class="overflow-x-auto">
            <table id="summaryTable" class="summary-table">
                <thead>
                    <tr>
                        <th>Year</th>
                        <th>
                            HVAC Event Capacity (kW)
                            <span class="tooltip-container">
                                <span class="info-icon">&#9432;</span>
                                <span class="tooltip-text">Instantaneous power reduction from HVAC devices.</span>
                            </span>
                        </th>
                        <th>
                            Water Heater Event Capacity (kW)
                            <span class="tooltip-container">
                                <span class="info-icon">&#9432;</span>
                                <span class="tooltip-text">Instantaneous power reduction from Water Heater devices.</span>
                            </span>
                        </th>
                        <th>
                            Total Event Capacity (kW)
                            <span class="tooltip-container">
                                <span class="info-icon">&#9432;</span>
                                <span class="tooltip-text">Combined instantaneous power reduction from all devices.</span>
                            </span>
                        </th>
                        <th>
                            Total Event Capacity (MW)
                            <span class="tooltip-container">
                                <span class="info-icon">&#9432;</span>
                                <span class="tooltip-text">Total Event Capacity in Megawatts (kW / 1000).</span>
                            </span>
                        </th>
                        <th>
                            Total Annual Energy Saved (GWh)
                            <span class="tooltip-container">
                                <span class="info-icon">&#9432;</span>
                                <span class="tooltip-text">Total energy saved over the year in Gigawatt-hours (kWh / 1,000,000).</span>
                            </span>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Rows will be populated by JavaScript -->
                </tbody>
            </table>
        </div>

        <div class="chart-container">
            <div class="chart-label">Total Event Capacity (MW) Over Time</div>
            <div id="controllableLoadChart">
                <!-- Chart bars will be populated by JavaScript -->
            </div>
        </div>

    </div>

    <script>
        // --- Model Data and State ---
        // This object holds all the model's assumptions and calculated results.
        const model = {
            // Editable assumptions, linked to input fields
            assumptions: {
                projectionYears: 15,
                totalAddressableHomeowners: 3200000, // Now represents initial installed base
                eligibleMarketPenetration: 0.85, 
                hvacLifespan: 12, // Changed default to 12 years
                whLifespan: 8, // Changed default to 8 years
                hvacAnnualReplacementOpportunity: 266667, // New input, default based on 3.2M * 0.85 / 12 (approx)
                whAnnualReplacementOpportunity: 400000, // New input, default based on 3.2M * 0.85 / 8 (approx)
                adoptionRateY1_2: 0.005, 
                adoptionRateY3_5: 0.015, 
                adoptionRateY6_10: 0.010, 
                adoptionRateY11_15plus: 0.005, 
                hvacKwReduction: 1.25, 
                whKwReduction: 0.75, 
                hvacCoincidenceFactor: 0.80, 
                whCoincidenceFactor: 0.40, 
                hvacParticipationRate: 0.88, 
                whParticipationRate: 0.80, 
                realWorldDerateFactor: 0.85, 
            },
            // Fixed assumptions, not user-editable but part of the model's context
            fixedAssumptions: {
                programType: "On-Bill Financing for appliance replacement",
                targetedAppliances: "High-efficiency Central HVAC (16 SEER2+) and Hybrid Electric Water Heaters (UEF 3.0+)",
                loadControlTechnology: "Direct Load Control (DLC) switches/devices directly on the appliance",
                loadControlEventDuration: "Typical 2-4 hours per event.", 
                loadControlEventFrequency: "Assumed: 5-10 events per month during peak season (e.g., June-September), with a maximum of 20-30 events annually. (Note: This frequency is a key operational decision; starting with lower frequency for a new program may enhance customer satisfaction and sustained participation.)", 
                customerOverride: "Program includes a customer override option for load control events",
                geographicScope: "FPL residential service territory",
                eventsPerYear: 25, // Moved to fixed
                avgHoursPerEvent: 3, // Moved to fixed
                noExistingDRPrograms: "Model does not incorporate historical FPL-specific DR data",
                noSmartMeterDisaggregation: "Model uses direct kW reduction estimates, not derived from smart meter disaggregation."
            },
            // Calculated projections for each device type
            hvacProjections: [],
            whProjections: [],
            // Consolidated summary of controllable load and energy
            summary: [],
            // Overall summary for the top section (data still calculated, just not rendered directly)
            overallSummary: {
                hvacActiveDevices: 0,
                hvacControllableLoad: 0,
                hvacAnnualEnergySaved: 0,
                whActiveDevices: 0,
                whControllableLoad: 0,
                whAnnualEnergySaved: 0,
                totalControllableLoadMw: 0,
                totalAnnualEnergySavedGWh: 0,
            }
        };

        // --- DOM Elements ---
        // References to input fields
        const inputElements = {
            projectionYears: document.getElementById('projectionYears'),
            totalAddressableHomeowners: document.getElementById('totalAddressableHomeowners'),
            eligibleMarketPenetration: document.getElementById('eligibleMarketPenetration'),
            adoptionRateY1_2: document.getElementById('adoptionRateY1_2'),
            adoptionRateY3_5: document.getElementById('adoptionRateY3_5'),
            adoptionRateY6_10: document.getElementById('adoptionRateY6_10'),
            adoptionRateY11_15plus: document.getElementById('adoptionRateY11_15plus'),
            hvacLifespan: document.getElementById('hvacLifespan'),
            whLifespan: document.getElementById('whLifespan'),
            hvacAnnualReplacementOpportunity: document.getElementById('hvacAnnualReplacementOpportunity'), // New
            whAnnualReplacementOpportunity: document.getElementById('whAnnualReplacementOpportunity'),     // New
            hvacKwReduction: document.getElementById('hvacKwReduction'),
            whKwReduction: document.getElementById('whKwReduction'),
            hvacCoincidenceFactor: document.getElementById('hvacCoincidenceFactor'), 
            whCoincidenceFactor: document.getElementById('whCoincidenceFactor'),   
            hvacParticipationRate: document.getElementById('hvacParticipationRate'), 
            whParticipationRate: document.getElementById('whParticipationRate'),   
            realWorldDerateFactor: document.getElementById('realWorldDerateFactor'),
        };

        // References to table bodies and chart container
        const hvacTableBody = document.querySelector('#hvacProjectionsTable tbody');
        const whTableBody = document.querySelector('#whProjectionsTable tbody');
        const summaryTableBody = document.querySelector('#summaryTable tbody');
        const controllableLoadChart = document.getElementById('controllableLoadChart');

        // --- Calculation Logic ---

        /**
         * Determines the annual adoption rate based on the current year and defined program phases.
         * @param {number} year - The current year in the projection (1-indexed).
         * @param {object} assumptions - The model's assumption object.
         * @returns {number} The adoption rate for the given year (as a decimal).
         */
        function getAnnualAdoptionRate(year, assumptions) {
            if (year >= 1 && year <= 2) {
                return assumptions.adoptionRateY1_2;
            } else if (year >= 3 && year <= 5) {
                return assumptions.adoptionRateY3_5;
            } else if (year >= 6 && year <= 10) {
                return assumptions.adoptionRateY6_10;
            } else if (year >= 11) {
                return assumptions.adoptionRateY11_15plus;
            }
            return 0; // Should not be reached for valid years
        }

        /**
         * Calculates the year-by-year projections for a specific device type (HVAC or Water Heater).
         * This function simulates the enrollment, retirement, and active device count over time.
         * @param {string} deviceType - Identifier for the device ('hvac' or 'wh').
         * @param {object} assumptions - The model's assumption object.
         * @param {object} fixedAssumptions - The model's fixed assumption object.
         * @returns {Array<object>} An array of annual projection objects for the device.
         */
        function calculateDeviceProjections(deviceType, assumptions, fixedAssumptions) {
            const projections = [];
            const deviceLifespan = assumptions[`${deviceType}Lifespan`];
            const baseKwReduction = assumptions[`${deviceType}KwReduction`];
            const deviceCoincidenceFactor = assumptions[`${deviceType}CoincidenceFactor`]; 
            const deviceParticipationRate = assumptions[`${deviceType}ParticipationRate`]; 
            
            // Calculate the true addressable market based on penetration factor from the total installed base
            const effectiveEligibleInstalledBase = assumptions.totalAddressableHomeowners * assumptions.eligibleMarketPenetration;
            
            // Annual Replacement Opportunity is now a direct input
            const annualReplacementOpportunityInput = assumptions[`${deviceType}AnnualReplacementOpportunity`];

            const realWorldDerateFactor = assumptions.realWorldDerateFactor;
            const eventsPerYear = fixedAssumptions.eventsPerYear; // From fixed assumptions
            const avgHoursPerEvent = fixedAssumptions.avgHoursPerEvent; // From fixed assumptions

            // Initialize data for Year 0 (before program launch)
            projections.push({
                year: 0,
                // Eligible Market Remaining now tracks the total eligible devices not yet enrolled
                eligibleMarketRemaining: effectiveEligibleInstalledBase, 
                annualAdoptionRate: 0,
                annualReplacementOpportunity: annualReplacementOpportunityInput, // Added for Year 0
                newInstallations: 0,
                cumulativeInstallations: 0,
                devicesRetired: 0,
                cumulativeActiveDevices: 0,
                eventCapacity: 0, 
                annualEnergySaved: 0,
            });

            // Loop through each projection year
            for (let y = 1; y <= assumptions.projectionYears; y++) {
                const prevYearData = projections[y - 1];
                const annualAdoptionRate = getAnnualAdoptionRate(y, assumptions);

                // New Installations are now driven by the annual replacement opportunity input
                // and the adoption rate applied to that opportunity.
                const newInstallations = Math.floor(annualReplacementOpportunityInput * annualAdoptionRate);
                
                const cumulativeInstallations = prevYearData.cumulativeInstallations + newInstallations;

                // Calculate devices that retire this year based on their lifespan
                let devicesRetired = 0;
                if (y > deviceLifespan) {
                    // Look back to the year when these devices were installed
                    const yearOfInstallationForRetirement = y - deviceLifespan;
                    if (projections[yearOfInstallationForRetirement]) {
                        devicesRetired = projections[yearOfInstallationForRetirement].newInstallations;
                    }
                }

                // Calculate the net number of active devices contributing to load control
                const cumulativeActiveDevices = Math.max(0, prevYearData.cumulativeActiveDevices + newInstallations - devicesRetired);

                // Eligible Market Remaining for the table: total eligible minus what's cumulatively installed
                const eligibleMarketRemaining = Math.max(0, effectiveEligibleInstalledBase - cumulativeInstallations);

                // Calculate the instantaneous event capacity for this device type in this year
                // Now uses device-specific coincidence and participation factors
                const eventCapacity = cumulativeActiveDevices * baseKwReduction * deviceCoincidenceFactor * deviceParticipationRate * realWorldDerateFactor;

                // Calculate the annual energy saved (kWh) for this device type in this year
                const annualEnergySaved = eventCapacity * eventsPerYear * avgHoursPerEvent;

                // Store the calculated data for the current year
                projections.push({
                    year: y,
                    eligibleMarketRemaining: eligibleMarketRemaining,
                    annualAdoptionRate: annualAdoptionRate,
                    annualReplacementOpportunity: annualReplacementOpportunityInput, // Added for each year
                    newInstallations: newInstallations,
                    cumulativeInstallations: cumulativeInstallations,
                    devicesRetired: devicesRetired,
                    cumulativeActiveDevices: cumulativeActiveDevices,
                    eventCapacity: eventCapacity,
                    annualEnergySaved: annualEnergySaved,
                });
            }
            return projections;
        }

        /**
         * Orchestrates the calculation of all model data: device projections and overall summary.
         */
        function calculateModel() {
            // 1. Calculate device-specific projections
            model.hvacProjections = calculateDeviceProjections('hvac', model.assumptions, model.fixedAssumptions);
            model.whProjections = calculateDeviceProjections('wh', model.assumptions, model.fixedAssumptions);

            // 2. Calculate summary for tables
            model.summary = [];
            for (let y = 0; y <= model.assumptions.projectionYears; y++) {
                const hvacKw = model.hvacProjections[y] ? model.hvacProjections[y].eventCapacity : 0;
                const whKw = model.whProjections[y] ? model.whProjections[y].eventCapacity : 0;
                const hvacKwh = model.hvacProjections[y] ? model.hvacProjections[y].annualEnergySaved : 0;
                const whKwh = model.whProjections[y] ? model.whProjections[y].annualEnergySaved : 0;

                const totalKw = hvacKw + whKw;
                const totalKwh = hvacKwh + whKwh;

                model.summary.push({
                    year: y,
                    hvacKw: hvacKw,
                    whKw: whKw,
                    totalKw: totalKw,
                    totalMw: totalKw / 1000,
                    totalKwh: totalKwh,
                    totalGwh: totalKwh / 1000000, // Convert kWh to GWh
                });
            }

            // 3. Calculate overall summary for the top section (data still calculated, just not rendered directly)
            const finalYear = model.assumptions.projectionYears;
            model.overallSummary.hvacActiveDevices = model.hvacProjections[finalYear] ? model.hvacProjections[finalYear].cumulativeActiveDevices : 0;
            model.overallSummary.hvacControllableLoad = model.hvacProjections[finalYear] ? model.hvacProjections[finalYear].eventCapacity : 0;
            model.overallSummary.hvacAnnualEnergySaved = model.hvacProjections[finalYear] ? model.hvacProjections[finalYear].annualEnergySaved : 0;

            model.overallSummary.whActiveDevices = model.whProjections[finalYear] ? model.whProjections[finalYear].cumulativeActiveDevices : 0;
            model.overallSummary.whControllableLoad = model.whProjections[finalYear] ? model.whProjections[finalYear].eventCapacity : 0;
            model.overallSummary.whAnnualEnergySaved = model.whProjections[finalYear] ? model.whProjections[finalYear].annualEnergySaved : 0;

            model.overallSummary.totalControllableLoadMw = model.summary[finalYear] ? model.summary[finalYear].totalMw : 0;
            model.overallSummary.totalAnnualEnergySavedGWh = model.summary[finalYear] ? model.summary[finalYear].totalGwh : 0;
        }

        // --- Rendering Logic ---

        /**
         * This function is now empty as the overall summary section HTML is removed.
         */
        function renderOverallSummary() {
            // No DOM elements to update for the overall summary section.
            // The model.overallSummary object still gets calculated and holds the data.
        }

        /**
         * Renders a detailed projection table for a specific device type.
         * @param {HTMLElement} tableBody - The tbody element to populate.
         * @param {Array<object>} data - The projection data for the device.
         */
        function renderProjectionsTable(tableBody, data) {
            tableBody.innerHTML = ''; // Clear existing rows
            data.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.year}</td>
                    <td>${row.eligibleMarketRemaining.toLocaleString()}</td>
                    <td>${(row.annualAdoptionRate * 100).toFixed(2)}%</td>
                    <td>${row.annualReplacementOpportunity.toLocaleString()}</td> <!-- New Column -->
                    <td>${row.newInstallations.toLocaleString()}</td>
                    <td>${row.cumulativeInstallations.toLocaleString()}</td>
                    <td>${row.devicesRetired.toLocaleString()}</td>
                    <td>${row.cumulativeActiveDevices.toLocaleString()}</td>
                    <td>${row.eventCapacity.toLocaleString(undefined, { maximumFractionDigits: 0 })}</td>
                    <td>${row.annualEnergySaved.toLocaleString(undefined, { maximumFractionDigits: 0 })}</td>
                `;
                tableBody.appendChild(tr);
            });
        }

        /**
         * Renders the consolidated total controllable load summary table.
         * @param {HTMLElement} tableBody - The tbody element to populate.
         * @param {Array<object>} data - The summary data.
         */
        function renderSummaryTable(tableBody, data) {
            tableBody.innerHTML = ''; // Clear existing rows
            data.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.year}</td>
                    <td>${row.hvacKw.toLocaleString(undefined, { maximumFractionDigits: 0 })}</td>
                    <td>${row.whKw.toLocaleString(undefined, { maximumFractionDigits: 0 })}</td>
                    <td>${row.totalKw.toLocaleString(undefined, { maximumFractionDigits: 0 })}</td>
                    <td>${row.totalMw.toLocaleString(undefined, { maximumFractionDigits: 2 })}</td>
                    <td>${row.totalGwh.toLocaleString(undefined, { maximumFractionDigits: 2 })}</td>
                `;
                tableBody.appendChild(tr);
            });
        }

        /**
         * Renders a simple bar chart to visualize the total controllable load over time.
         * @param {HTMLElement} chartContainer - The container for the chart.
         * @param {Array<object>} data - The summary data.
         */
        function renderChart(chartContainer, data) {
            chartContainer.innerHTML = ''; // Clear existing chart
            // Find the maximum MW value to scale the bars correctly
            const maxMw = Math.max(...data.map(d => d.totalMw));

            data.forEach(row => {
                if (row.year === 0) return; // Skip year 0 for chart as it's typically zero load

                // Handle division by zero if maxMw is 0
                const barWidth = (maxMw === 0) ? 0 : (row.totalMw / maxMw) * 100;
                
                const chartRow = document.createElement('div');
                chartRow.classList.add('chart-row');
                chartRow.innerHTML = `
                    <div class="chart-year">Y${row.year}:</div>
                    <div class="chart-bar-container">
                        <div class="chart-bar" style="width: ${barWidth}%"></div>
                    </div>
                    <div class="chart-value">${row.totalMw.toLocaleString(undefined, { maximumFractionDigits: 2 })} MW</div>
                `;
                chartContainer.appendChild(chartRow);
            });
        }

        /**
         * Main render function to update all sections of the model.
         */
        function renderModel() {
            renderOverallSummary(); 
            renderProjectionsTable(hvacTableBody, model.hvacProjections);
            renderProjectionsTable(whTableBody, model.whProjections);
            renderSummaryTable(summaryTableBody, model.summary);
            renderChart(controllableLoadChart, model.summary);
        }

        // --- Event Listeners and Initialization ---

        /**
         * Handles changes to input fields, updates the corresponding assumption,
         * and triggers a full model recalculation and re-render.
         * @param {Event} event - The input change event.
         */
        function updateAssumption(event) {
            const inputId = event.target.id;
            let value = parseFloat(event.target.value);

            // Convert percentages from input (e.g., 1.5 -> 0.015)
            if (inputId.includes('adoptionRate') || inputId.includes('Factor') || inputId.includes('Rate') || inputId.includes('Penetration')) {
                value /= 100;
            }

            // Update the model's assumptions
            model.assumptions[inputId] = value;
            // Recalculate and re-render the entire model
            calculateModel();
            renderModel();
        }

        // Attach event listeners to all input fields in the assumptions section
        for (const key in inputElements) {
            if (inputElements.hasOwnProperty(key)) {
                inputElements[key].addEventListener('input', updateAssumption);
            }
        }

        /**
         * Initializes input fields with default assumption values on page load.
         * Also converts decimal percentages back to display percentages for inputs.
         */
        function initializeInputs() {
            for (const key in inputElements) {
                if (inputElements.hasOwnProperty(key)) {
                    let value = model.assumptions[key];
                    // Convert decimals back to percentages for display in input fields
                    if (key.includes('adoptionRate') || key.includes('Factor') || key.includes('Rate') || key.includes('Penetration')) {
                        value *= 100;
                    }
                    // Ensure specific input values (like kW reduction) are displayed with appropriate precision
                    if (key === 'hvacKwReduction' || key === 'whKwReduction') {
                        inputElements[key].value = value.toFixed(2);
                    } else {
                        inputElements[key].value = value;
                    }
                }
            }
        }

        // Initial setup:
        // 1. Initialize input fields with default values.
        // 2. Perform the initial model calculation.
        // 3. Render all components of the model.
        initializeInputs();
        calculateModel();
        renderModel();
    </script>
</body>
</html>
